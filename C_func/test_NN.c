#include<stdio.h>
#include<math.h>
#include<time.h>

clock_t start, finish;
double total_time;

static float roll_ref;

#define dim_X  2
#define dim_Y  1
#define dim_H1  8
#define dim_H2  8

float w1[2][8] = {2.6432145, -2.062055, 1.6860175, -2.2040405, 1.9950366, -1.9266196, 2.0164046, 0.32374448, 0.06623013, -0.1304981, -0.20041433, 0.21009707, -0.06575617, 0.36230823, 0.13322192, 0.03038317};
float w2[8][8] = {-1.0877609, 0.7226832, 1.0301503, 0.9946335, -0.07043737, 1.23102, -1.2549849, -0.6485276, 0.9147414, -0.45687428, -0.11187978, -0.7880311, -0.28141645, -0.20392114, 0.94008183, 0.84743327, -0.06744982, 0.28731605, 0.18879215, 0.25525808, -0.09342301, 0.35373327, -0.2152298, -0.025302442, 0.999425, -0.31815568, -0.3809926, -0.7895009, -0.09907308, -0.39351603, 0.62534297, 0.79094243, -0.5320276, 0.8485637, 0.6309634, 0.8228931, 0.1760911, 0.32894346, -0.87447506, -0.70813966, 0.66626, -0.15117572, -0.49871376, -0.15521502, -0.21152453, -0.43223685, 0.5026806, 0.7576167, -0.49052933, -0.031461336, 0.57978237, 0.7030146, -0.16903351, 0.53712726, -0.031609338, -0.514456, -0.33527696, -0.042122394, -0.18698086, 0.038426667, 0.09451556, 0.13774323, -0.0823504, 0.287312};
float w3[8][1] = {-0.8504606, 0.7781583, 0.74910927, 0.8946703, -0.23114371, 0.56927186, -0.87686783, -0.85267204};
float b1[8] = {0.2193612, 0.6418117, 0.64840865, 0.29698047, 0.36658624, 0.693159, 0.7358691, -0.5724967};
float b2[8] = {0.3217498, 0.32910088, 0.15778354, 0.21605076, -0.06508833, 0.28884885, 0.34433135, 0.23646857};
float b3[1] = {0.2319684};


double relu(double x)
{
	return (fabs(x) + x) / 2.0;
}

double tanh(double x)
{
	return (exp(x) - exp(-x)) / (exp(x) + exp(-x));
}

void NNcontroller(float roll, float rollrate, float d_roll)
{

	float e_roll  = (d_roll - roll);

	//float X[dim_X] = {0.05, 3.0};
	float X[dim_X] = {e_roll, rollrate};
	float H1[dim_H1];
	float H2[dim_H2];
	float Y[dim_Y];
	int i, j;
	// X to H1
	for(i=0; i<dim_H1; i++)
	{
		H1[i] = 0.0; 
		for(j=0; j<dim_X; j++)
		{
			H1[i] += X[j] * w1[j][i];
		}
		H1[i] = relu(H1[i] + b1[i]);
	}

	// H1 to H2
	for(i=0; i<dim_H2; i++)
	{
		H2[i] = 0.0;
		for(j=0; j<dim_H1; j++)
		{
			H2[i] += H1[j] * w2[j][i];
		}
		H2[i] = relu(H2[i] + b2[i]);
	}
	// H2 to Y
	for(i=0; i<dim_Y; i++)
	{
		Y[i] = 0.0;
		for(j=0; j<dim_H2; j++)
		{
			Y[i] += H2[j] * w3[j][i];
		}
		Y[i] = tanh(Y[i] + b3[i]);
	}

	// motor_diff input values to static variables
	roll_ref  = Y[0] * 2;

}

int main()
{
	start = clock();
	NNcontroller(0.0, 0.1, 0.0);  // test numbers
	finish = clock();
	total_time = (double)(finish - start) / CLOCKS_PER_SEC * 1000;
	printf("TIME: %f ms \n", total_time);
	printf("motor_roll:  %f\n", roll_ref);

	return 0;
}